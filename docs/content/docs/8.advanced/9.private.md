---
title: Encrypted Dumps
description: Encrypted Dumps in Nuxt Content allow you to serve content safely on a public CDN while requiring authentication to access it.
---

Encrypted Dumps in Nuxt Content allow you to serve your content safely on a public CDN (e.g. Cloudflare Pages) without exposing the raw `.sql` database files.  
Instead, dumps are encrypted at build time and decrypted in the browser only after the user has authenticated and received a short-lived key.

They are especially useful for:

- Hosting private content on static/CDN deployments
- Keeping v3’s fast client-side SQLite queries without leaking raw dumps
- Adding fine-grained access control using your own authentication

## How it works

1. **Build** – Each collection is compressed and encrypted with AES-256-GCM.  
2. **Static hosting** – Only encrypted `.enc` files are published (`dump.<collection>.sql.enc`).  
3. **Key request** – The client requests a short-lived key from `/api/__nuxt_content/:collection/key`.  
4. **Decrypt & hydrate** – The browser decrypts the dump in memory and hydrates its WASM SQLite database.  

Without the key, the dumps are useless.

## Static files produced

When `encryption.enabled = true`:

- ✅ `dump.<collection>.sql.enc` → Encrypted database dump, safe to host on CDN.  
- ✅ `database/queries/*.sql` → Still generated internally, but not exposed publicly.  
- ❌ No `.sql` or `.txt` raw dumps are emitted to `public/` or `_nuxt/`.  

When `encryption.enabled = false` (default):

- Raw `.sql` or `.txt` dumps are emitted and directly fetched by the client (legacy behavior).


## API endpoints

Nuxt Content automatically provides endpoints for both **encrypted** and **legacy** modes.

### 1. Encrypted mode

- `GET /api/__nuxt_content/:collection/sql_dump.enc`  
  Returns the encrypted dump envelope (stringified JSON, base64).  
  Safe to cache on a CDN.

- `GET /api/__nuxt_content/:collection/key`  
  Returns `{ kid, k }` where `k` is the short-lived base64-encoded AES key.  
  Must be protected with **your authentication middleware**.  
  This endpoint is the only place the actual key is exposed.

### 2. Legacy mode

- `GET /api/__nuxt_content/:collection/sql_dump.txt`  
  Returns the raw compressed SQL array (unsafe for private data).  
  Still available when `encryption.enabled = false`.

- `POST /api/__nuxt_content/:collection/query`  
  Runs an SQL query against the collection database.  
  Used internally by the client after the dump is hydrated.

## Enable encryption

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  content: {
    encryption: {
      enabled: true,
      masterKey: process.env.NUXT_CONTENT_MASTER_KEY, // base64(32 bytes)
    }
  }
})
```

Generate a master key:

```bash
openssl rand -base64 32
# or
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

## Authentication middleware

You must protect the **key endpoint** so only authenticated users receive decryption keys:

```ts [server/middleware/auth-key.ts]
import { eventHandler, createError } from 'h3'

export default eventHandler(async (event) => {
  const url = new URL(event.node.req.url || '', 'http://localhost')
  if (!url.pathname.endsWith('/key')) return

  // Example check: replace with your own session/JWT/CF Access logic
  const authorized = event.node.req.headers.get('cookie')?.includes('session=')
  if (!authorized) {
    throw createError({ statusCode: 401, statusMessage: 'Unauthorized' })
  }
})
```

## Summary

* Encrypted dumps are **safe static artifacts**.
* API endpoints provide either the encrypted blob or a short-lived key.
* Middleware is required to control who can fetch keys.
* Clients transparently decrypt and hydrate, preserving v3’s offline & fast querying benefits.